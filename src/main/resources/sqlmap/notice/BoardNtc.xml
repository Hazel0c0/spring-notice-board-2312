<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="NoticeService">

    <select id="getBoardList" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT ROWNUM
        ,POST_SQNO
        ,POST_TIT
        ,CASE WHEN MAIN_VW_POP_MK_YN = '1' THEN 'Y' ELSE '' END AS MAIN_VW_POP_MK_YN_YN
        ,ATTFL_ID_YN
        ,REG_DTM
        ,MOD_DTM
        ,(SELECT EMP_NM FROM TB_SB_CM_EMP WHERE ENO = A.REGMN_ID) AS EMP_NM
        ,SCH_NT
        ,( SELECT Z.DISABLED_1DAY
        FROM TB_SB_CM_SCH_DAY Z
        WHERE Z.ENO = #{ENO}
        AND Z.BIZ_DSC = 'NTC'
        AND Z.POST_SQNO = A.POST_SQNO ) AS DISABLED_1DAY
        FROM
        (
        SELECT POST_SQNO,
        POST_TIT,
        CASE WHEN ATTFL_ID IS NULL THEN 'N' ELSE 'Y' END AS ATTFL_ID_YN,
        REG_DTM,
        MOD_DTM,
        MAIN_VW_POP_MK_YN,
        REGMN_ID,
        SCH_NT
        FROM TB_SB_OT_BORD_J A
        WHERE 1=1
        AND POST_TP_DSC = '1'
        AND DEL_YN = '0'
        <if test="REG_ST_DT != '' and REG_ST_DT != null">
            AND SUBSTR(A.REG_DTM,1,6) BETWEEN #{REG_ST_DT} AND #{REG_ED_DT}
        </if>
        <if test="POST_TIT != '' and POST_TIT != null">
            AND UPPER(POST_TIT) LIKE UPPER('%'||#{POST_TIT}||'%')
        </if>
        <if test="REGMN_ID != '' and REGMN_ID != null">
            AND (
            REGMN_ID LIKE '%' || #{REGMN_ID} || '%'
            OR
            REGMN_ID IN (
            SELECT ENO
            FROM TB_SB_CM_EMP
            WHERE EMP_NM LIKE '%' || #{REGMN_ID} || '%'
            )
            )
        </if>
        ORDER BY POST_SQNO DESC
        ) A
        <if test="rownum != null and rownum!=''">
            WHERE rownum <![CDATA[ <=]]>#{rownum}
        </if>
    </select>
    <select id="selectBoardList" parameterType="java.util.Map"
            resultType="java.util.HashMap">
        SELECT POST_SQNO
             , POST_TIT
             , POST_CNTN
             , MAIN_VW_POP_MK_YN
             , GRP_POST_SQNO
             , GRP_POST_STP_NO
             , GRP_POST_LVL_NO
             , SCH_NT
             , REGMN_ID
             , ATTFL_ID
             , (SELECT EMP_NM FROM TB_SB_CM_EMP WHERE ENO = A.REGMN_ID) AS EMP_NM
        FROM TB_SB_OT_BORD_J A
        WHERE POST_TP_DSC = '1'
          AND POST_SQNO = #{POST_SQNO}
    </select>


    <insert id="insertBoard" parameterType="java.util.Map">
        INSERT INTO TB_SB_OT_BORD (
        POST_TP_DSC,
        POST_SQNO,
        CO_CD,
        POST_TIT,
        POST_CNTN,
        MAIN_VW_POP_MK_YN,
        <if test="ATTFL_ID != '' and ATTFL_ID != null">
            ATTFL_ID,
        </if>
        DEL_YN,
        SCH_NT,
        REGMN_ID,
        REG_DTM
        ) VALUES (
        '1',
        (SELECT (CASE WHEN MAX(POST_SQNO) IS NULL THEN 0 ELSE MAX(POST_SQNO) END)+1 FROM TB_SB_OT_BORD
        WHERE POST_TP_DSC = '1'),
        '',
        #{POST_TIT},
        #{POST_CNTN},
        #{MAIN_VW_POP_MK_YN},
        <if test="ATTFL_ID != '' and ATTFL_ID != null">
            #{ATTFL_ID},
        </if>
        '0',
        0,
        #{REGMN_ID},
        TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')
        )
    </insert>

    <update id="updateBoard" parameterType="java.util.Map">
        UPDATE TB_SB_OT_BORD
        SET POST_TIT          = #{POST_TIT}
          , POST_CNTN         = #{POST_CNTN}
          , MAIN_VW_POP_MK_YN = #{MAIN_VW_POP_MK_YN}
          , ATTFL_ID          = #{ATTFL_ID}
          , MODMN_ID          = #{MODMN_ID}
          , MOD_DTM           = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        WHERE POST_SQNO = #{POST_SQNO}
          AND POST_TP_DSC = '1'
    </update>

    <delete id="deleteBoard" parameterType="java.util.Map">
        UPDATE TB_SB_OT_BORD
        SET DEL_YN   = '1'
          , MODMN_ID = #{MODMN_ID}
          , MOD_DTM  = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        WHERE POST_SQNO = #{POST_SQNO}
          AND POST_TP_DSC = '1'
    </delete>

    <update id="updateBoardSchNt" parameterType="String">
        UPDATE TB_SB_OT_BORD
        SET SCH_NT = SCH_NT + 1
        WHERE POST_SQNO = #{POST_SQNO}
          AND POST_TP_DSC = '1'
    </update>

    <update id="update_1day_disabled" parameterType="java.util.Map">
        UPDATE TB_SB_CM_SCH_DAY
        SET DISABLED_1DAY = TO_CHAR(SYSDATE, 'YYYYMMDD')
          , MODMN_ID      = #{MODMN_ID}
          , MOD_DTM       = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        WHERE POST_SQNO = #{POST_SQNO}
          AND ENO = #{ENO}
          AND BIZ_DSC = 'NTC'
    </update>

</mapper>
